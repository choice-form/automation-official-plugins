name: Icon Validation

on:
  pull_request:
    paths:
      - "tools/*/icon.*"
      - "extensions/*/icon.*"
      - "models/*/icon.*"

jobs:
  validate-icons:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install image validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick librsvg2-bin
          npm install -g svgo

      - name: Validate icons
        run: |
          echo "ğŸ¨ Starting icon validation..."

          # æŸ¥æ‰¾æ‰€æœ‰å›¾æ ‡æ–‡ä»¶
          find . -name "icon.*" -type f | while read icon_file; do
            echo "ğŸ“ Validating: $icon_file"
            
            # è·å–æ–‡ä»¶ä¿¡æ¯
            file_size=$(stat -c%s "$icon_file")
            file_ext="${icon_file##*.}"
            
            # éªŒè¯æ–‡ä»¶æ ¼å¼
            case "${file_ext,,}" in
              svg)
                echo "âœ… SVG format detected"
                
                # æ£€æŸ¥ SVG æ–‡ä»¶å¤§å°
                if [ $file_size -gt 10240 ]; then # 10KB
                  echo "âŒ SVG file too large: ${file_size} bytes (max: 10KB)"
                  echo "suggestion=Consider optimizing your SVG with SVGO" >> $GITHUB_OUTPUT
                  exit 1
                fi
                
                # éªŒè¯ SVG å†…å®¹
                if grep -q "javascript\|script\|onclick" "$icon_file"; then
                  echo "âŒ SVG contains JavaScript (not allowed)"
                  exit 1
                fi
                
                # æ£€æŸ¥ SVG å°ºå¯¸
                svg_info=$(identify -format "%w %h" "$icon_file" 2>/dev/null || echo "0 0")
                width=$(echo $svg_info | cut -d' ' -f1)
                height=$(echo $svg_info | cut -d' ' -f2)
                
                if [ "$width" != "$height" ]; then
                  echo "âš ï¸  Warning: Icon is not square (${width}x${height})"
                  echo "suggestion=Please use square dimensions for better display" >> $GITHUB_OUTPUT
                fi
                
                # ä¼˜åŒ– SVGï¼ˆå¦‚æœéœ€è¦ï¼‰
                if [ $file_size -gt 5120 ]; then # 5KB
                  echo "ğŸ”§ Optimizing SVG..."
                  svgo --input "$icon_file" --output "${icon_file}.optimized" --quiet
                  optimized_size=$(stat -c%s "${icon_file}.optimized")
                  echo "ğŸ“Š Original: ${file_size}B â†’ Optimized: ${optimized_size}B"
                  
                  if [ $optimized_size -lt $file_size ]; then
                    echo "suggestion=Your SVG can be optimized to save $(( (file_size - optimized_size) ))B" >> $GITHUB_OUTPUT
                  fi
                  rm -f "${icon_file}.optimized"
                fi
                ;;
                
              png)
                echo "âœ… PNG format detected"
                
                # æ£€æŸ¥ PNG æ–‡ä»¶å¤§å°
                if [ $file_size -gt 20480 ]; then # 20KB
                  echo "âŒ PNG file too large: ${file_size} bytes (max: 20KB)"
                  echo "suggestion=Consider using SVG format or compressing PNG" >> $GITHUB_OUTPUT
                  exit 1
                fi
                
                # è·å– PNG å°ºå¯¸
                png_info=$(identify -format "%w %h" "$icon_file")
                width=$(echo $png_info | cut -d' ' -f1)
                height=$(echo $png_info | cut -d' ' -f2)
                
                # éªŒè¯å°ºå¯¸
                if [ "$width" != "$height" ]; then
                  echo "âŒ PNG must be square, got ${width}x${height}"
                  exit 1
                fi
                
                                 if [ $width -lt 16 ] || [ $width -gt 128 ]; then
                   echo "âŒ PNG size ${width}x${height} outside allowed range (16x16 to 128x128)"
                   exit 1
                 fi
                
                # æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜èƒŒæ™¯
                if ! identify -format "%A" "$icon_file" | grep -q "True"; then
                  echo "âš ï¸  Warning: PNG doesn't have transparency"
                  echo "suggestion=Consider adding transparent background for better integration" >> $GITHUB_OUTPUT
                fi
                ;;
                
              jpg|jpeg)
                echo "âš ï¸  JPEG format detected (not recommended)"
                
                if [ $file_size -gt 15360 ]; then # 15KB
                  echo "âŒ JPEG file too large: ${file_size} bytes (max: 15KB)"
                  exit 1
                fi
                
                echo "suggestion=Consider using SVG or PNG with transparency instead of JPEG" >> $GITHUB_OUTPUT
                ;;
                
              *)
                echo "âŒ Unsupported format: $file_ext"
                echo "suggestion=Please use SVG (recommended), PNG, or JPEG format" >> $GITHUB_OUTPUT
                exit 1
                ;;
            esac
            
            echo "âœ… Icon validation passed: $icon_file"
          done

          echo "ğŸ‰ All icons validated successfully!"

      - name: Comment on PR with suggestions
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const suggestions = [];

            // è¯»å–æ‰€æœ‰å»ºè®®
            if (fs.existsSync(process.env.GITHUB_OUTPUT)) {
              const output = fs.readFileSync(process.env.GITHUB_OUTPUT, 'utf8');
              const lines = output.split('\n');
              
              lines.forEach(line => {
                if (line.startsWith('suggestion=')) {
                  suggestions.push(line.substring(11));
                }
              });
            }

            if (suggestions.length > 0) {
              const body = `## ğŸ¨ Icon Validation Results

            Your icons have been validated! Here are some suggestions for improvement:

            ${suggestions.map(s => `- ğŸ’¡ ${s}`).join('\n')}

            ### ğŸ“ Icon Guidelines

            **Recommended Specs:**
            - **Format**: SVG (preferred) or PNG with transparency  
                         - **Size**: 24x24px to 128x128px, square (1:1 ratio)
            - **File Size**: SVG â‰¤ 10KB, PNG â‰¤ 20KB
            - **Style**: Simple, clear, recognizable at small sizes

            **SVG Requirements:**
            - No external dependencies
            - No JavaScript code
            - Optimized paths and shapes

            Need help? Check our [Icon Design Guide](https://github.com/choice-form/automation-official-plugins/blob/main/docs/ICON_GUIDELINES.md) ğŸ¯`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
