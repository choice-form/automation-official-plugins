name: Official Plugin Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  detect-changes:
    name: Detect Changed Plugins
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.changes.outputs.plugins }}
      has_plugins: ${{ steps.changes.outputs.has_plugins }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Plugins
        id: changes
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶å¹¶å»é™¤å‰å¯¼ç©ºæ ¼
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | sed 's/^[[:space:]]*//')

          # æå–æ’ä»¶ç›®å½• (extensions/plugin-name, models/plugin-name, tools/plugin-name)
          PLUGINS=$(echo "$CHANGED_FILES" | grep -E '^(extensions|models|tools)/[^/]+/' | cut -d'/' -f1-2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "Changed plugins: $PLUGINS"
          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

          if [[ "$PLUGINS" != "[]" ]]; then
            echo "has_plugins=true" >> $GITHUB_OUTPUT
          else
            echo "has_plugins=false" >> $GITHUB_OUTPUT
          fi

  strict-validation:
    name: Strict Plugin Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_plugins == 'true'
    strategy:
      matrix:
        plugin: ${{ fromJson(needs.detect-changes.outputs.plugins) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install Dependencies
        run: |
          cd ${{ matrix.plugin }}
          npm install

      - name: Install Plugin SDK
        run: |
          cd ${{ matrix.plugin }}
          npm install @choiceform/automation-sdk@latest

      - name: Strict Structure Validation
        run: |
          PLUGIN_DIR="${{ matrix.plugin }}"
          echo "ğŸ” å®˜æ–¹æ’ä»¶ä¸¥æ ¼éªŒè¯: $PLUGIN_DIR"

          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          REQUIRED_FILES=(
            "package.json"
            "plugin.manifest.json"
            "README.md"
            "CHANGELOG.md"
            "src/index.ts"
            "tests/"
            "tsconfig.json"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -e "$PLUGIN_DIR/$file" ]]; then
              echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
              exit 1
            fi
          done

          echo "âœ… æ–‡ä»¶ç»“æ„æ£€æŸ¥é€šè¿‡"

      - name: TypeScript Compilation
        run: |
          cd ${{ matrix.plugin }}
          npx tsc --noEmit

      - name: Code Quality Check
        run: |
          cd ${{ matrix.plugin }}
          # ESLint æ£€æŸ¥
          npx eslint src/ --ext .ts || echo "âš ï¸ ESLintæ£€æŸ¥å»ºè®®ä¿®å¤"
          # Prettier æ£€æŸ¥
          npx prettier --check "src/**/*.ts" || echo "âš ï¸ ä»£ç æ ¼å¼å»ºè®®ä¼˜åŒ–"

      - name: Comprehensive Testing
        run: |
          cd ${{ matrix.plugin }}
          npm test || echo "âš ï¸ å»ºè®®æ·»åŠ å®Œæ•´æµ‹è¯•"

          # æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
          npm run test:coverage || echo "âš ï¸ å»ºè®®æ·»åŠ æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥"

      - name: Security Audit
        run: |
          cd ${{ matrix.plugin }}
          # é«˜çº§åˆ«å®‰å…¨æ‰«æ
          npm audit --audit-level=high || echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ä¿®å¤"

          # æ£€æŸ¥å±é™©ä¾èµ–
          if grep -r "eval\|Function\|exec\|spawn" src/; then
            echo "âš ï¸ å‘ç°æ½œåœ¨å±é™©å‡½æ•°ï¼Œéœ€è¦äººå·¥å®¡æ ¸"
          fi

      - name: Plugin SDK Validation
        run: |
          cd ${{ matrix.plugin }}
          npx @choiceform/automation-sdk validate .

      - name: Documentation Quality Check
        run: |
          PLUGIN_DIR="${{ matrix.plugin }}"

          # æ£€æŸ¥ README å®Œæ•´æ€§
          if ! grep -q "## åŠŸèƒ½ç‰¹æ€§\|## Features" "$PLUGIN_DIR/README.md"; then
            echo "âŒ README.md ç¼ºå°‘åŠŸèƒ½ç‰¹æ€§è¯´æ˜"
            exit 1
          fi

          if ! grep -q "## ä½¿ç”¨æ–¹æ³•\|## Usage" "$PLUGIN_DIR/README.md"; then
            echo "âŒ README.md ç¼ºå°‘ä½¿ç”¨æ–¹æ³•è¯´æ˜"
            exit 1
          fi

          echo "âœ… æ–‡æ¡£è´¨é‡æ£€æŸ¥é€šè¿‡"

  official-review-summary:
    name: Official Plugin Review Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, strict-validation]
    if: always() && needs.detect-changes.outputs.has_plugins == 'true'
    steps:
      - name: Generate Review Summary
        uses: actions/github-script@v7
        with:
          script: |
            const plugins = ${{ needs.detect-changes.outputs.plugins }};
            const validationResult = '${{ needs.strict-validation.result }}';

            let summary = `## ğŸ¢ å®˜æ–¹æ’ä»¶å®¡æ ¸æŠ¥å‘Š\n\n`;
            summary += `**å®¡æ ¸æ’ä»¶**: ${plugins.join(', ')}\n\n`;

            if (validationResult === 'success') {
              summary += `### âœ… è‡ªåŠ¨éªŒè¯é€šè¿‡\n\n`;
              summary += `æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥å·²é€šè¿‡ï¼Œå·²å‡†å¤‡å¥½è¿›è¡Œäººå·¥å®¡æ ¸ã€‚\n\n`;
            } else {
              summary += `### âŒ è‡ªåŠ¨éªŒè¯å¤±è´¥\n\n`;
              summary += `è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡æ–°æäº¤ã€‚\n\n`;
            }

            // å®˜æ–¹æ’ä»¶çš„ä¸¥æ ¼æ¸…å•
            summary += `### ğŸ“‹ å®˜æ–¹æ’ä»¶å®¡æ ¸æ¸…å•\n\n`;
            summary += `#### ğŸ¤– è‡ªåŠ¨åŒ–æ£€æŸ¥\n`;
            summary += `- [${validationResult === 'success' ? 'x' : ' '}] æ’ä»¶ç»“æ„å®Œæ•´\n`;
            summary += `- [${validationResult === 'success' ? 'x' : ' '}] TypeScript ç¼–è¯‘é€šè¿‡\n`;
            summary += `- [${validationResult === 'success' ? 'x' : ' '}] ä»£ç è´¨é‡æ£€æŸ¥\n`;
            summary += `- [${validationResult === 'success' ? 'x' : ' '}] å®‰å…¨å®¡è®¡\n`;
            summary += `- [${validationResult === 'success' ? 'x' : ' '}] æ–‡æ¡£è´¨é‡è¾¾æ ‡\n\n`;

            summary += `#### ğŸ‘¤ äººå·¥å®¡æ ¸ (æ ¸å¿ƒå›¢é˜Ÿè´Ÿè´£)\n`;
            summary += `- [ ] åŠŸèƒ½è®¾è®¡åˆç†æ€§å®¡æ ¸\n`;
            summary += `- [ ] ä»£ç æ¶æ„å’Œæœ€ä½³å®è·µå®¡æ ¸\n`;
            summary += `- [ ] æ€§èƒ½å’Œèµ„æºä½¿ç”¨å®¡æ ¸\n`;
            summary += `- [ ] å®‰å…¨é£é™©æ·±åº¦è¯„ä¼°\n`;
            summary += `- [ ] æ–‡æ¡£å®Œæ•´æ€§å’Œå‡†ç¡®æ€§å®¡æ ¸\n`;
            summary += `- [ ] é•¿æœŸç»´æŠ¤è®¡åˆ’ç¡®è®¤\n\n`;

            summary += `### ğŸ“š å®˜æ–¹æ’ä»¶æ ‡å‡†\n\n`;
            summary += `ä½œä¸ºå®˜æ–¹æ’ä»¶ï¼Œæ­¤æ’ä»¶å°†ä»£è¡¨ ChoiceForm çš„è´¨é‡æ ‡å‡†ã€‚\n\n`;
            summary += `æ’ä»¶ç±»å‹è¯´æ˜:\n`;
            summary += `- **Extensions**: è½»é‡çº§ HTTP ç«¯ç‚¹åŠŸèƒ½\n`;
            summary += `- **Models**: AI æ¨¡å‹é›†æˆ\n`;
            summary += `- **Tools**: ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ\n\n`;

            if (validationResult === 'success') {
              summary += `### âœ… ä¸‹ä¸€æ­¥\n\n`;
              summary += `è‡ªåŠ¨åŒ–éªŒè¯å·²é€šè¿‡ï¼Œç­‰å¾…æ ¸å¿ƒå›¢é˜Ÿè¿›è¡Œäººå·¥å®¡æ ¸ã€‚\n`;
            } else {
              summary += `### âŒ ä¿®å¤å»ºè®®\n\n`;
              summary += `è¯·æŸ¥çœ‹ä¸Šè¿°å¤±è´¥çš„æ£€æŸ¥é¡¹ï¼Œä¿®å¤åé‡æ–°æäº¤ã€‚\n`;
            }

            // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('å®˜æ–¹æ’ä»¶å®¡æ ¸æŠ¥å‘Š')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
