name: Plugin Auto Publish

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

jobs:
  detect-changes:
    name: Detect Plugin Changes
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.changes.outputs.plugins }}
      has_plugins: ${{ steps.changes.outputs.has_plugins }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Plugins
        id: changes
        run: |
          # è·å–æœ€è¿‘çš„æäº¤ä¸­å˜æ›´çš„æ’ä»¶
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå‘å¸ƒæ‰€æœ‰æ’ä»¶
            PLUGINS=$(find extensions models tools -maxdepth 1 -mindepth 1 -type d | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            # è‡ªåŠ¨è§¦å‘æ—¶ï¼Œåªå‘å¸ƒæœ‰å˜æ›´çš„æ’ä»¶
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            PLUGINS=$(echo "$CHANGED_FILES" | grep -E '^(extensions|models|tools)/[^/]+/' | cut -d'/' -f1-2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          echo "Plugins to publish: $PLUGINS"
          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

          if [[ "$PLUGINS" != "[]" ]]; then
            echo "has_plugins=true" >> $GITHUB_OUTPUT
          else
            echo "has_plugins=false" >> $GITHUB_OUTPUT
          fi

  build-plugins:
    name: Build Plugin Packages
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_plugins == 'true'
    strategy:
      matrix:
        plugin: ${{ fromJson(needs.detect-changes.outputs.plugins) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install Dependencies
        run: |
          cd ${{ matrix.plugin }}
          npm install

      - name: Install Plugin SDK
        run: |
          cd ${{ matrix.plugin }}
          npm install @choiceform/automation-sdk@latest

      - name: Build Plugin
        run: |
          cd ${{ matrix.plugin }}
          npm run build

      - name: Package Plugin
        run: |
          cd ${{ matrix.plugin }}
          npx @choiceform/automation-sdk build

          # è¯»å–æ’ä»¶ä¿¡æ¯
          PLUGIN_NAME=$(node -p "require('./package.json').name")
          PLUGIN_VERSION=$(node -p "require('./package.json').version")

          # æŸ¥æ‰¾ .choiceformpkg æ–‡ä»¶
          if ls *.choiceformpkg 1> /dev/null 2>&1; then
            echo "Found .choiceformpkg files"
            echo "SDKå·²ç»ç”Ÿæˆäº†åŒ…æ–‡ä»¶"
          else
            echo "No .choiceformpkg files found, creating package manually..."
            
            # åˆ›å»ºä¸´æ—¶åŒ…ç›®å½•
            mkdir -p temp_package
            
            # å¤åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶å’Œé…ç½®
            if [ -d "dist" ]; then
              echo "Copying dist files..."
              cp -r dist/* temp_package/
            else
              echo "No dist directory found"
            fi
            
            # å¤åˆ¶å¿…è¦æ–‡ä»¶
            [ -f "package.json" ] && cp package.json temp_package/ && echo "Copied package.json"
            [ -f "plugin.manifest.json" ] && cp plugin.manifest.json temp_package/ && echo "Copied manifest"
            [ -f "plugin.registry.json" ] && cp plugin.registry.json temp_package/ && echo "Copied registry"
            [ -f "README.md" ] && cp README.md temp_package/ && echo "Copied README"
            [ -f "icon.svg" ] && cp icon.svg temp_package/ && echo "Copied icon"
            
            # å¦‚æœæ²¡æœ‰ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œå¤åˆ¶æºæ–‡ä»¶
            if [ ! -d "dist" ] && [ -d "src" ]; then
              echo "No dist found, copying src files..."
              cp -r src temp_package/
            fi
            
            # åˆ›å»ºåŒ…æ–‡ä»¶ï¼ˆä½¿ç”¨å®‰å…¨çš„æ–‡ä»¶åï¼‰
            SAFE_NAME=$(echo "$PLUGIN_NAME" | sed 's/[@\/]/-/g' | sed 's/^-//' | sed 's/-$//')
            PACKAGE_NAME="${SAFE_NAME}-${PLUGIN_VERSION}.choiceformpkg"
            
            # æ£€æŸ¥ä¸´æ—¶ç›®å½•å†…å®¹
            echo "Contents of temp_package:"
            ls -la temp_package/
            
            cd temp_package
            tar -czf "../${PACKAGE_NAME}" .
            cd ..
            
            # éªŒè¯åŒ…æ–‡ä»¶åˆ›å»ºæˆåŠŸ
            if [ -f "${PACKAGE_NAME}" ]; then
              echo "âœ… Package created successfully: ${PACKAGE_NAME}"
              echo "Package size: $(ls -lh ${PACKAGE_NAME} | awk '{print $5}')"
            else
              echo "âŒ Failed to create package: ${PACKAGE_NAME}"
              exit 1
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf temp_package
          fi

      - name: Check Created Files
        run: |
          echo "Files in plugin directory:"
          ls -la ${{ matrix.plugin }}/*.choiceformpkg || echo "No .choiceformpkg files in ${{ matrix.plugin }}"

      - name: Generate Artifact Name
        id: artifact-name
        run: |
          SAFE_NAME=$(echo "${{ matrix.plugin }}" | sed 's/\//-/g')
          echo "name=plugin-${SAFE_NAME}" >> $GITHUB_OUTPUT

      - name: Upload Plugin Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: "${{ matrix.plugin }}/*.choiceformpkg"
          retention-days: 30

  create-release:
    name: Create Plugin Release
    runs-on: ubuntu-latest
    needs: [detect-changes, build-plugins]
    if: needs.detect-changes.outputs.has_plugins == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Generate Release Notes
        id: release-notes
        run: |
          PLUGINS='${{ needs.detect-changes.outputs.plugins }}'

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          echo "## ğŸš€ Official Plugins Release $(date +'%Y-%m-%d')" > release-notes.md
          echo "" >> release-notes.md
          echo "### ğŸ“¦ Updated Plugins" >> release-notes.md
          echo "" >> release-notes.md

          for plugin in $(echo $PLUGINS | jq -r '.[]'); do
            if [[ -d "$plugin" ]]; then
              PLUGIN_NAME=$(node -p "require('./$plugin/package.json').name" 2>/dev/null || echo "$plugin")
              PLUGIN_VERSION=$(node -p "require('./$plugin/package.json').version" 2>/dev/null || echo "unknown")
              PLUGIN_DESC=$(node -p "require('./$plugin/package.json').description" 2>/dev/null || echo "")
              
              echo "#### $PLUGIN_NAME v$PLUGIN_VERSION" >> release-notes.md
              echo "$PLUGIN_DESC" >> release-notes.md
              echo "" >> release-notes.md
            fi
          done

          echo "### ğŸ“¥ Installation" >> release-notes.md
          echo "" >> release-notes.md
          echo "å®˜æ–¹æ’ä»¶å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£…ï¼š" >> release-notes.md
          echo "" >> release-notes.md
          echo "1. **è‡ªåŠ¨å®‰è£…**ï¼šåœ¨ ChoiceForm Automation æ’ä»¶å¸‚åœºä¸­æœç´¢å¹¶å®‰è£…" >> release-notes.md
          echo "2. **æ‰‹åŠ¨å®‰è£…**ï¼šä¸‹è½½ .choiceformpkg æ–‡ä»¶å¹¶å¯¼å…¥" >> release-notes.md
          echo "3. **SDK å®‰è£…**ï¼šä½¿ç”¨ \`@choiceform/automation-sdk\` å‘½ä»¤è¡Œå·¥å…·" >> release-notes.md
          echo "" >> release-notes.md

          # è®¾ç½®è¾“å‡º
          echo "RELEASE_TAG=v$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-notes.outputs.RELEASE_TAG }}
          name: Official Plugins Release ${{ steps.release-notes.outputs.RELEASE_TAG }}
          body_path: release-notes.md
          files: release-artifacts/**/*.choiceformpkg
          draft: false
          prerelease: false

  update-registry:
    name: Update Plugin Registry
    runs-on: ubuntu-latest
    needs: [detect-changes, build-plugins, create-release]
    if: needs.detect-changes.outputs.has_plugins == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate Plugin Registry
        run: |
          mkdir -p registry

          # ç”Ÿæˆæ’ä»¶æ³¨å†Œè¡¨
          echo "Generating plugin registry..."

          # ç”ŸæˆåŸºç¡€ JSON ç»“æ„
          CURRENT_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > registry/registry.json << EOF
          {
            "version": "1.0.0",
            "generated": "$CURRENT_DATE",
            "repository": "automation-official-plugins",
            "plugins": {
              "extensions": [],
              "models": [],
              "tools": []
            }
          }
          EOF

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ„å»ºå®Œæ•´çš„ JSON
          echo '{"version": "1.0.0","generated": "'$CURRENT_DATE'","repository": "automation-official-plugins","plugins": {"extensions": [],"models": [],"tools": []}}' > temp_registry.json

          # æ‰«ææ¯ä¸ªæ’ä»¶ç±»å‹å¹¶åŠ¨æ€æ„å»º JSON
          for category in extensions models tools; do
            if [[ -d "$category" ]]; then
              for plugin_dir in $category/*/; do
                if [[ -f "$plugin_dir/package.json" ]]; then
                  echo "Processing $plugin_dir..."
                  
                  # è¯»å–æ’ä»¶ä¿¡æ¯
                  PLUGIN_NAME=$(node -p "require('./$plugin_dir/package.json').name" 2>/dev/null || echo "")
                  PLUGIN_VERSION=$(node -p "require('./$plugin_dir/package.json').version" 2>/dev/null || echo "1.0.0")
                  PLUGIN_DESC=$(node -p "require('./$plugin_dir/package.json').description" 2>/dev/null || echo "")
                  PLUGIN_AUTHOR=$(node -p "require('./$plugin_dir/package.json').author" 2>/dev/null || echo "ChoiceForm")
                  
                  if [[ ! -z "$PLUGIN_NAME" ]]; then
                    # åˆ›å»ºå®‰å…¨çš„æ–‡ä»¶åï¼ˆæ›¿æ¢ç‰¹æ®Šå­—ç¬¦ï¼‰
                    SAFE_NAME=$(echo "$PLUGIN_NAME" | sed 's/[@\/]/-/g' | sed 's/^-//' | sed 's/-$//')
                    PACKAGE_NAME="${SAFE_NAME}-${PLUGIN_VERSION}.choiceformpkg"
                    
                    # ä½¿ç”¨ jq æ·»åŠ æ’ä»¶åˆ°å¯¹åº”åˆ†ç±»
                    PLUGIN_ENTRY=$(cat << EOF
          {
            "name": "$PLUGIN_NAME",
            "version": "$PLUGIN_VERSION", 
            "description": "$PLUGIN_DESC",
            "author": "$PLUGIN_AUTHOR",
            "category": "$category",
            "download_url": "https://github.com/choice-form/automation-official-plugins/releases/latest/download/${PACKAGE_NAME}",
            "repository_url": "https://github.com/choice-form/automation-official-plugins/tree/main/$plugin_dir",
            "updated_at": "$CURRENT_DATE"
          }
          EOF
          )
                    # ä½¿ç”¨ jq å°†æ’ä»¶æ·»åŠ åˆ°å¯¹åº”åˆ†ç±»
                    echo "$PLUGIN_ENTRY" | jq -c '.' > temp_plugin.json
                    cat temp_registry.json | jq ".plugins.$category += [$(cat temp_plugin.json)]" > temp_registry_new.json
                    mv temp_registry_new.json temp_registry.json
                    echo "Added $PLUGIN_NAME to $category registry"
                  fi
                fi
              done
            fi
          done

          # ç¾åŒ– JSON å¹¶ä¿å­˜
          cat temp_registry.json | jq '.' > registry/registry.json
          rm -f temp_registry.json temp_plugin.json

          # ç”Ÿæˆ HTML é¡µé¢
          cat > registry/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>ChoiceForm Official Plugins Registry</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
              .plugin { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
              .category { margin: 20px 0; }
              .category h2 { color: #333; border-bottom: 2px solid #007cba; padding-bottom: 5px; }
            </style>
          </head>
          <body>
            <h1>ğŸ”Œ ChoiceForm Official Plugins</h1>
            <p>å®˜æ–¹ç»´æŠ¤çš„é«˜è´¨é‡æ’ä»¶é›†åˆ</p>
            
            <div class="category">
              <h2>ğŸ”§ Extensions (æ‰©å±•æ’ä»¶)</h2>
              <p>è½»é‡çº§ HTTP ç«¯ç‚¹åŠŸèƒ½</p>
            </div>
            
            <div class="category">
              <h2>ğŸ¤– Models (æ¨¡å‹æ’ä»¶)</h2>
              <p>AI æ¨¡å‹é›†æˆ</p>
            </div>
            
            <div class="category">  
              <h2>ğŸ› ï¸ Tools (å·¥å…·æ’ä»¶)</h2>
              <p>ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ</p>
            </div>
            
            <hr>
            <p><small>Generated: $(date)</small></p>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: registry/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Registry Info
        run: |
          echo "âœ… Plugin Registry Generated Successfully!"
          echo "ğŸ“ Registry files created in registry/ directory"
          if [ -f registry/registry.json ]; then
            echo "ğŸ“‹ registry.json size: $(stat -c%s registry/registry.json 2>/dev/null || stat -f%z registry/registry.json) bytes"
          fi
          if [ -f registry/index.html ]; then
            echo "ğŸŒ index.html size: $(stat -c%s registry/index.html 2>/dev/null || stat -f%z registry/index.html) bytes"
          fi
          echo "ğŸ”— If GitHub Pages deployment failed, you can manually upload these files"
