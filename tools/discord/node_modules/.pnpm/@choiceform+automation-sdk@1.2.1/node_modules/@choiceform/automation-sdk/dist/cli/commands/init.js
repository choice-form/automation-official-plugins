import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';
import fs from 'fs-extra';
import path from 'path';
import validateNpmName from 'validate-npm-package-name';
import { renderTemplate } from '../utils/template.js';
import { initGitRepo } from '../utils/git.js';
/**
 * æ ¹æ®æ’ä»¶ç±»å‹å’Œç‰¹æ€§é€‰æ‹©åˆé€‚çš„æ¨¡æ¿
 */
function getTemplateNameByType(pluginType, features) {
    // æ™ºèƒ½æ¨¡æ¿é€‰æ‹©é€»è¾‘
    if (pluginType === 'trigger') {
        if (features.includes('http')) {
            return 'webhook-trigger'; // å®Œæ•´çš„ HTTP Webhook è§¦å‘å™¨
        }
        return 'generic'; // é€šç”¨è§¦å‘å™¨æ¨¡æ¿
    }
    if (pluginType === 'action') {
        if (features.includes('http')) {
            return 'http-action'; // HTTP Action æ¨¡æ¿ (æš‚æœªå®ç°ï¼Œä½¿ç”¨é€šç”¨)
        }
        return 'generic';
    }
    if (pluginType === 'transform') {
        return 'data-transform'; // æ•°æ®è½¬æ¢æ¨¡æ¿ (æš‚æœªå®ç°ï¼Œä½¿ç”¨é€šç”¨)
    }
    return 'generic'; // é€šç”¨åå¤‡æ¨¡æ¿
}
export async function initCommand(projectName, options = {}) {
    console.log(chalk.cyan('ğŸš€ åˆ›å»º Automation èŠ‚ç‚¹æ’ä»¶ - ä¸“ä¸šçš„å·¥ä½œæµå¼€å‘æ¡†æ¶\n'));
    // 1. é¡¹ç›®åç§°å¤„ç†
    let finalProjectName = projectName;
    if (!finalProjectName) {
        const { name } = await inquirer.prompt([
            {
                type: 'input',
                name: 'name',
                message: 'é¡¹ç›®åç§°:',
                default: 'my-awesome-plugin',
                validate: (input) => {
                    const validation = validateNpmName(input);
                    if (!validation.validForNewPackages) {
                        return validation.errors?.[0] || 'æ— æ•ˆçš„é¡¹ç›®åç§°';
                    }
                    return true;
                }
            }
        ]);
        finalProjectName = name;
    }
    // 2. æ’ä»¶ç±»å‹é€‰æ‹© (å‚è€ƒå·¥ä½œæµå¼•æ“çš„èŠ‚ç‚¹åˆ†ç±»ä½“ç³»)
    const { pluginType, features, advanced } = await inquirer.prompt([
        {
            type: 'list',
            name: 'pluginType',
            message: 'é€‰æ‹©æ’ä»¶ç±»å‹ (åŸºäºèŠ‚ç‚¹å¼å·¥ä½œæµä½“ç³»):',
            choices: [
                {
                    name: 'ğŸ”” Trigger - è§¦å‘å™¨èŠ‚ç‚¹ (å¯åŠ¨å·¥ä½œæµï¼Œå¦‚ Webhookã€å®šæ—¶å™¨ã€æ–‡ä»¶ç›‘å¬)',
                    value: 'trigger'
                },
                {
                    name: 'âš¡ Action - åŠ¨ä½œèŠ‚ç‚¹ (æ‰§è¡Œæ“ä½œï¼Œå¦‚ HTTPè¯·æ±‚ã€é‚®ä»¶å‘é€ã€æ•°æ®åº“æ“ä½œ)',
                    value: 'action'
                },
                {
                    name: 'ğŸ”„ Transform - è½¬æ¢èŠ‚ç‚¹ (æ•°æ®å¤„ç†ï¼Œå¦‚ä»£ç æ‰§è¡Œã€æ•°æ®æ ¼å¼åŒ–ã€æ¡ä»¶åˆ¤æ–­)',
                    value: 'transform'
                },
                {
                    name: 'ğŸ”§ Utility - å·¥å…·èŠ‚ç‚¹ (æµç¨‹æ§åˆ¶ï¼Œå¦‚åˆ†æ”¯ã€åˆå¹¶ã€å¾ªç¯ã€å»¶è¿Ÿ)',
                    value: 'utility'
                },
                {
                    name: 'ğŸ“¦ Package - èŠ‚ç‚¹åŒ… (å¤šä¸ªç›¸å…³èŠ‚ç‚¹çš„ç»„åˆåŒ…)',
                    value: 'package'
                }
            ]
        },
        {
            type: 'checkbox',
            name: 'features',
            message: 'é€‰æ‹©åŠŸèƒ½ç‰¹æ€§ (ä¸“ä¸šå·¥ä½œæµç‰¹æ€§):',
            choices: [
                { name: 'ğŸ“Š æ•°æ®æŒä¹…åŒ– (æœ¬åœ°å­˜å‚¨ï¼ŒçŠ¶æ€ç®¡ç†)', value: 'persistence' },
                { name: 'ğŸŒ HTTP é›†æˆ (REST APIã€Webhook æ”¯æŒ)', value: 'http' },
                { name: 'ğŸ”’ å‡­æ®ç®¡ç† (APIå¯†é’¥ã€OAuthä»¤ç‰Œ)', value: 'credentials' },
                { name: 'ğŸ¨ è‡ªå®šä¹‰ç•Œé¢ (å‚æ•°é…ç½®ã€çŠ¶æ€æ˜¾ç¤º)', value: 'ui' },
                { name: 'ğŸ“ åŠ¨æ€å‚æ•° (è¡¨è¾¾å¼æ”¯æŒã€å˜é‡ç»‘å®š)', value: 'parameters' },
                { name: 'ğŸ”„ å®æ—¶ç›‘å¬ (æ–‡ä»¶å˜åŒ–ã€æ•°æ®åº“äº‹ä»¶)', value: 'events' },
                { name: 'ğŸŒ¡ï¸ å¥åº·æ£€æŸ¥ (è¿æ¥æµ‹è¯•ã€çŠ¶æ€ç›‘æ§)', value: 'health' },
                { name: 'ğŸ” è°ƒè¯•æ¨¡å¼ (æ—¥å¿—è¾“å‡ºã€é”™è¯¯è·Ÿè¸ª)', value: 'debug' }
            ],
            default: []
        },
        {
            type: 'confirm',
            name: 'advanced',
            message: 'å¯ç”¨é«˜çº§å¼€å‘ç‰¹æ€§? (çƒ­é‡è½½ã€ç±»å‹å®‰å…¨ã€é”™è¯¯å¤„ç†)',
            default: true
        }
    ]);
    // 3. é¡¹ç›®é…ç½®
    const projectPath = path.join(options.dir || '.', finalProjectName);
    if (await fs.pathExists(projectPath)) {
        console.log(chalk.red(`âŒ ç›®å½• ${projectPath} å·²å­˜åœ¨`));
        process.exit(1);
    }
    const spinner = ora('åˆ›å»ºä¸šå†…é¢†å…ˆçš„æ’ä»¶é¡¹ç›®...').start();
    try {
        // 4. åˆ›å»ºé¡¹ç›®ç›®å½•
        await fs.ensureDir(projectPath);
        // 5. ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ (ä½¿ç”¨æ¨¡æ¿ç³»ç»Ÿ)
        const templateData = {
            projectName: finalProjectName,
            pluginType,
            features,
            advanced,
            typescript: options.typescript !== false, // é»˜è®¤å¯ç”¨ TypeScript
            author: process.env.USER || 'Developer',
            date: new Date().toISOString(),
            description: `A ${pluginType} node for Automation platform - Compatible with workflow automation system`
        };
        // ç”Ÿæˆæ ¸å¿ƒæ–‡ä»¶ (ä½¿ç”¨æ™ºèƒ½æ¨¡æ¿é€‰æ‹©)
        const templateName = getTemplateNameByType(pluginType, features);
        await renderTemplate(templateName, projectPath, templateData);
        spinner.text = 'é¡¹ç›®åˆ›å»ºå®Œæˆ...';
        spinner.succeed('é¡¹ç›®æ–‡ä»¶åˆ›å»ºå®Œæˆ');
        // 7. åˆå§‹åŒ– Git ä»“åº“
        if (options.git !== false) {
            const gitSpinner = ora('åˆå§‹åŒ– Git ä»“åº“...').start();
            try {
                await initGitRepo(projectPath);
                gitSpinner.succeed('Git ä»“åº“åˆå§‹åŒ–å®Œæˆ');
            }
            catch (error) {
                gitSpinner.warn('Git ä»“åº“åˆå§‹åŒ–å¤±è´¥ (å¯èƒ½æœªå®‰è£… Git)');
            }
        }
        // 8. æˆåŠŸæç¤º
        console.log(chalk.green('\nâœ¨ ä¸“ä¸šèŠ‚ç‚¹æ’ä»¶é¡¹ç›®åˆ›å»ºæˆåŠŸ!\n'));
        console.log(chalk.cyan('ğŸš€ ç‰¹æ€§äº®ç‚¹:'));
        console.log(chalk.gray('  â€¢ å®Œå…¨å…¼å®¹èŠ‚ç‚¹å¼å·¥ä½œæµä½“ç³»'));
        console.log(chalk.gray('  â€¢ TypeScript ç±»å‹å®‰å…¨'));
        console.log(chalk.gray('  â€¢ çƒ­é‡è½½å¼€å‘ä½“éªŒ'));
        console.log(chalk.gray('  â€¢ nodes-config ä¸¥æ ¼å…¼å®¹'));
        console.log(chalk.gray('  â€¢ å·¥ä½œæµçº§åˆ«çš„é”™è¯¯å¤„ç†'));
        console.log();
        console.log(chalk.cyan('ä¸‹ä¸€æ­¥æ“ä½œ:'));
        console.log(chalk.gray(`  cd ${finalProjectName}`));
        console.log(chalk.gray('  pnpm install'));
        console.log(chalk.gray('  automation-plugin dev'));
        console.log();
        console.log(chalk.yellow('ğŸ“– æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md'));
    }
    catch (error) {
        spinner.fail('é¡¹ç›®åˆ›å»ºå¤±è´¥');
        console.error(chalk.red(error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'));
        process.exit(1);
    }
}
