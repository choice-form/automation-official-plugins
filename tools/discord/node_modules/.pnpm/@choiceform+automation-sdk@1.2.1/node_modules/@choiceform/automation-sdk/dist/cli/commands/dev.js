import chalk from 'chalk';
import ora from 'ora';
import express from 'express';
import { WebSocketServer } from 'ws';
import chokidar from 'chokidar';
import fs from 'fs-extra';
import path from 'path';
export async function devCommand(options = {}) {
    console.log(chalk.cyan('ğŸ”§ å¯åŠ¨å¼€å‘è°ƒè¯•æ¨¡å¼\n'));
    const port = parseInt(options.port || '3000');
    const host = options.host || 'localhost';
    // æ£€æŸ¥æ˜¯å¦åœ¨æ’ä»¶é¡¹ç›®ç›®å½•
    const manifestPath = path.join(process.cwd(), 'plugin.manifest.json');
    if (!await fs.pathExists(manifestPath)) {
        console.log(chalk.red('âŒ å½“å‰ç›®å½•ä¸æ˜¯æœ‰æ•ˆçš„æ’ä»¶é¡¹ç›®'));
        console.log(chalk.yellow('ğŸ’¡ è¯·åœ¨æ’ä»¶é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤å‘½ä»¤'));
        process.exit(1);
    }
    const spinner = ora('å¯åŠ¨å¼€å‘æœåŠ¡å™¨...').start();
    try {
        // 1. åˆ›å»º Express åº”ç”¨
        const app = express();
        app.use(express.json());
        app.use(express.static('dist'));
        // 2. æ’ä»¶çƒ­é‡è½½ API
        app.post('/api/reload', async (req, res) => {
            try {
                // é‡æ–°åŠ è½½æ’ä»¶é…ç½®
                const manifest = await fs.readJson(manifestPath);
                res.json({ success: true, manifest });
            }
            catch (error) {
                res.status(500).json({
                    success: false,
                    error: error instanceof Error ? error.message : 'é‡è½½å¤±è´¥'
                });
            }
        });
        // 3. æ’ä»¶çŠ¶æ€ API
        app.get('/api/status', async (req, res) => {
            const manifest = await fs.readJson(manifestPath);
            res.json({
                status: 'running',
                plugin: manifest.name,
                version: manifest.version,
                uptime: process.uptime()
            });
        });
        // 4. å¯åŠ¨ HTTP æœåŠ¡å™¨
        const server = app.listen(port, host, () => {
            spinner.succeed('å¼€å‘æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ');
            console.log(chalk.green(`ğŸŒ æœåŠ¡å™¨è¿è¡Œåœ¨: http://${host}:${port}`));
            console.log(chalk.yellow('ğŸ”„ çƒ­é‡è½½å·²å¯ç”¨'));
            console.log(chalk.gray('ğŸ“ ä¿®æ”¹æ–‡ä»¶å°†è‡ªåŠ¨é‡æ–°åŠ è½½\n'));
        });
        // 5. åˆ›å»º WebSocket æœåŠ¡å™¨ (ç”¨äºå®æ—¶é€šä¿¡)
        const wss = new WebSocketServer({ server });
        wss.on('connection', (ws) => {
            console.log(chalk.blue('ğŸ”— æ–°çš„è°ƒè¯•è¿æ¥å»ºç«‹'));
            ws.on('close', () => {
                console.log(chalk.gray('ğŸ”Œ è°ƒè¯•è¿æ¥å…³é—­'));
            });
            // å‘é€åˆå§‹çŠ¶æ€
            ws.send(JSON.stringify({
                type: 'connected',
                message: 'è°ƒè¯•è¿æ¥å·²å»ºç«‹'
            }));
        });
        // 6. æ–‡ä»¶ç›‘å¬ (å€Ÿé‰´ Dify çš„çƒ­é‡è½½)
        if (options.watch) {
            const watcher = chokidar.watch(['src/**/*', '*.json'], {
                ignoreInitial: true,
                ignored: ['node_modules/**', 'dist/**']
            });
            watcher.on('change', async (filePath) => {
                console.log(chalk.yellow(`ğŸ“ æ–‡ä»¶å˜æ›´: ${filePath}`));
                // å¹¿æ’­å˜æ›´åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
                wss.clients.forEach((client) => {
                    if (client.readyState === 1) { // WebSocket.OPEN
                        client.send(JSON.stringify({
                            type: 'file-changed',
                            file: filePath,
                            timestamp: Date.now()
                        }));
                    }
                });
                // å¦‚æœæ˜¯é…ç½®æ–‡ä»¶å˜æ›´ï¼ŒéªŒè¯é…ç½®
                if (filePath.endsWith('.json') || filePath.endsWith('.yaml')) {
                    try {
                        await validatePluginConfig();
                        console.log(chalk.green('âœ… é…ç½®éªŒè¯é€šè¿‡'));
                    }
                    catch (error) {
                        console.log(chalk.red(`âŒ é…ç½®éªŒè¯å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`));
                    }
                }
            });
            // ä¼˜é›…å…³é—­
            process.on('SIGINT', () => {
                console.log(chalk.yellow('\nğŸ›‘ æ­£åœ¨å…³é—­å¼€å‘æœåŠ¡å™¨...'));
                watcher.close();
                server.close(() => {
                    console.log(chalk.green('âœ… å¼€å‘æœåŠ¡å™¨å·²å…³é—­'));
                    process.exit(0);
                });
            });
        }
    }
    catch (error) {
        spinner.fail('å¼€å‘æœåŠ¡å™¨å¯åŠ¨å¤±è´¥');
        console.error(chalk.red(error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'));
        process.exit(1);
    }
}
async function validatePluginConfig() {
    const manifestPath = path.join(process.cwd(), 'plugin.manifest.json');
    const manifest = await fs.readJson(manifestPath);
    // åŸºç¡€éªŒè¯
    if (!manifest.name || !manifest.version) {
        throw new Error('æ’ä»¶åç§°å’Œç‰ˆæœ¬ä¸èƒ½ä¸ºç©º');
    }
    // æ›´å¤šéªŒè¯é€»è¾‘...
}
